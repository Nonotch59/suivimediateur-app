<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enregistrement d'un Entretien</title>
  <script src="https://cdn.tailwindcss.com"></script>

 <!-- Firebase SDK v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
  // üîß Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDf8hbsFHQ5MAEssfM6SeF2s1Glc0JTS7U",
    authDomain: "suivimediateuras.firebaseapp.com",
    projectId: "suivimediateuras",
    storageBucket: "suivimediateuras.appspot.com",
    messagingSenderId: "385344535314",
    appId: "1:385344535314:web:019fb10e56e4a408a491cb"
  };

  // üöÄ Initialisation Firebase
  firebase.initializeApp(firebaseConfig);

  // üîê Authentification anonyme
  firebase.auth().signInAnonymously()
    .then(() => console.log("‚úÖ Connect√© √† Firebase"))
    .catch((error) => console.error("‚ùå Auth Firebase :", error.message));
</script>

  

</head>
<body class="relative min-h-screen">
  <div class="absolute inset-0">
    <img src="ADEF_HABITAT_IMAGE.jpg" alt="Fond" class="w-full h-full object-cover" />
    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
  </div>

  <div class="relative z-10 flex flex-col md:flex-row gap-6 p-4 md:p-10 text-white">
    <!-- Partie formulaire (1/2) -->
    <div class="w-full md:w-1/2 bg-white/10 backdrop-blur-md rounded-xl p-5 shadow-lg">
      <h2 class="text-2xl font-bold mb-2">Enregistrement d'un Entretien</h2>
      <a href="index.html" class="text-sm text-white underline hover:text-gray-200 mb-4 inline-block">‚¨Ö Retour √† l‚Äôaccueil</a>
      <form id="formulaire-entretien" class="space-y-2 text-sm">      
        <label class="font-semibold">Nom :</label>
        <select id="nom" class="w-full p-1.5 rounded text-black" required></select>

        <label class="font-semibold">Pr√©nom :</label>
        <select id="prenom" class="w-full p-1.5 rounded text-black" required></select>

        <label class="font-semibold">Num√©ro unique :</label>
        <input id="numero" class="w-full p-1.5 rounded text-black bg-gray-100" readonly type="text" />

        <label class="font-semibold">Type d'entretien :</label>
        <select id="type_entretien" class="w-full p-1.5 rounded text-black">
          <option value="individuel">Individuel</option>
          <option value="permanence">Permanence</option>
        </select>

        <label class="font-semibold">Th√®me abord√© :</label>
        <select id="theme" class="w-full p-1.5 rounded text-black">
          <option value="emploi">Emploi</option>
          <option value="logement">Logement</option>
          <option value="sante">Sant√©</option>
          <option value="formation">Formation</option>
        </select>

        <label class="font-semibold">Notes :</label>
        <textarea id="notes" class="w-full p-2 rounded text-black" placeholder="√âcrire une note..." rows="5"></textarea>

        <button type="button" onclick="ouvrirSignature()" class="bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded w-full font-semibold text-sm">
          Enregistrer l'entretien
        </button>
      </form>
    </div>



    <!-- Partie historique (2/2) -->
    <div class="w-full md:w-1/2 bg-white/10 backdrop-blur-md rounded-xl p-5 shadow-lg">
      <h2 class="text-xl font-bold mb-4">Historique du r√©sident</h2>
      <div class="flex flex-wrap items-center gap-3 mb-3">
        <button class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm font-semibold" onclick="exportHistoriqueCSV()">üìÑ Exporter en CSV</button>
        <select class="text-black text-sm px-2 py-1 rounded" id="filtre-type">
          <option value="">Tous types</option>
          <option value="individuel">Individuel</option>
          <option value="permanence">Permanence</option>
        </select>
        <div class="flex gap-1">
          <select class="text-black text-sm px-2 py-1 rounded" id="filtre-debut-mois"></select>
          <select class="text-black text-sm px-2 py-1 rounded" id="filtre-debut-annee"></select>
        </div>
        <div class="flex gap-1">
          <select class="text-black text-sm px-2 py-1 rounded" id="filtre-fin-mois"></select>
          <select class="text-black text-sm px-2 py-1 rounded" id="filtre-fin-annee"></select>
        </div>
      </div>
      <div class="overflow-x-auto text-sm" id="resident-historique"></div>
      <div class="mt-2 text-white text-sm flex items-center gap-4" id="pagination-historique">
        <button class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" onclick="changeHistoriquePage(-1)">‚¨Ö Pr√©c√©dent</button>
        <span id="page-historique-indicator">Page 1</span>
        <button class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" onclick="changeHistoriquePage(1)">Suivant ‚û°</button>
      </div>
    </div>
  </div>

<script>
let idResidentGlobal = null;
let currentHistPage = 1;
const limitHist = 10;
let totalHistPages = 1;
let currentHistId = null;

// R√©f√©rences aux filtres
const filtreType = document.getElementById("filtre-type");
const filtreDebutMois = document.getElementById("filtre-debut-mois");
const filtreDebutAnnee = document.getElementById("filtre-debut-annee");
const filtreFinMois = document.getElementById("filtre-fin-mois");
const filtreFinAnnee = document.getElementById("filtre-fin-annee");

// Remplissage des menus d√©roulants de mois/ann√©e
const moisNoms = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet",
  "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
moisNoms.forEach((nom, i) => {
  const val = String(i + 1).padStart(2, '0');
  [filtreDebutMois, filtreFinMois].forEach(sel => {
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = nom;
    sel.appendChild(opt);
  });
});
for (let y = 2022; y <= new Date().getFullYear(); y++) {
  [filtreDebutAnnee, filtreFinAnnee].forEach(sel => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    sel.appendChild(opt);
  });
}

// Valeurs par d√©faut des filtres
window.addEventListener("load", () => {
  filtreDebutMois.value = "01";
  filtreDebutAnnee.value = "2022";

  const now = new Date();
  filtreFinMois.value = String(now.getMonth() + 1).padStart(2, "0");
  filtreFinAnnee.value = now.getFullYear();
});

// Recharge l'historique si on change un filtre
filtreType.onchange = filtreDebutMois.onchange = filtreDebutAnnee.onchange =
filtreFinMois.onchange = filtreFinAnnee.onchange = () => {
  currentHistPage = 1;
  loadHistorique(currentHistId);
};

// R√©cup√©ration des r√©sidents (noms et pr√©noms)
window.onload = () => {
  fetch('/getResidents') // ‚ûú mets ici l'URL externe si besoin
    .then(res => res.json())
    .then(data => {
      const nomSelect = document.getElementById('nom');
      const prenomSelect = document.getElementById('prenom');

      nomSelect.innerHTML = '<option value="">-- Nom --</option>';
      prenomSelect.innerHTML = '<option value="">-- Pr√©nom --</option>';

      const noms = [...new Set(data.map(r => r.nom))];
      const prenoms = [...new Set(data.map(r => r.prenom))];

      noms.forEach(nom => {
        const opt = document.createElement('option');
        opt.value = nom;
        opt.textContent = nom;
        nomSelect.appendChild(opt);
      });

      prenoms.forEach(prenom => {
        const opt = document.createElement('option');
        opt.value = prenom;
        opt.textContent = prenom;
        prenomSelect.appendChild(opt);
      });
    });
};

// Lorsqu'on s√©lectionne le pr√©nom, on cherche le num√©ro unique
document.getElementById('prenom').addEventListener('change', () => {
  const nom = document.getElementById('nom').value;
  const prenom = document.getElementById('prenom').value;
  if (!nom || !prenom) return;

  fetch(`/resident/${nom}/${prenom}`) // ‚ûú √† adapter si tu utilises une URL compl√®te
    .then(res => res.json())
    .then(data => {
      if (data.numero_unique) {
        document.getElementById('numero').value = data.numero_unique;
        idResidentGlobal = data.id;
        currentHistId = data.id;
        currentHistPage = 1;
        loadHistorique(data.id);
      }
    });
});
</script>
  


<script>


// Fonction appel√©e apr√®s signature - VERSION CORRIG√âE
function envoyerFormulaire(signaturePath) {
  const type_entretien = document.getElementById('type_entretien').value;
  const themes_abordes = [document.getElementById('theme').value];
  const notes = document.getElementById('notes').value;

  fetch('/entretien', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id_resident: idResidentGlobal,
      type_entretien,
      themes_abordes,
      notes,
      signature_url: signaturePath  // üîÅ Ici on envoie le chemin Firebase, pas l‚Äôimage elle-m√™me
    })
  })
  .then(res => res.json())
  .then(() => {
    alert("‚úÖ Entretien enregistr√© avec signature !");
    document.getElementById('formulaire-entretien').reset();
    document.getElementById('numero').value = '';
    loadHistorique(idResidentGlobal);
  })
  .catch(err => {
    console.error(err);
    alert("‚ùå Erreur lors de l'enregistrement.");
  });
}

</script>


  <script>
function loadHistorique(id) {
  if (!id) return;
  currentHistId = id;
  const offset = (currentHistPage - 1) * limitHist;

  fetch(`/entretiens?resident_id=${id}`)
    .then(res => res.json())
    .then(allData => {
      const filtreT = filtreType.value;
      let filtreDebut = filtreDebutMois.value && filtreDebutAnnee.value ? new Date(`${filtreDebutAnnee.value}-${filtreDebutMois.value}-01`) : null;
      let filtreFin = filtreFinMois.value && filtreFinAnnee.value ? new Date(`${filtreFinAnnee.value}-${filtreFinMois.value}-31`) : null;

      const filtres = allData.filter(e => {
        const d = new Date(e.date);
        return (!filtreT || e.type_entretien === filtreT) &&
               (!filtreDebut || d >= filtreDebut) &&
               (!filtreFin || d <= filtreFin);
      });

      totalHistPages = Math.ceil(filtres.length / limitHist);
      const data = filtres.slice(offset, offset + limitHist);

      const container = document.getElementById("resident-historique");
      const pagination = document.getElementById("page-historique-indicator");
      pagination.textContent = `Page ${currentHistPage} / ${totalHistPages || 1}`;

      if (!data.length) {
        container.innerHTML = "<p class='text-white'>Aucun entretien trouv√©.</p>";
        return;
      }

      let html = `<table class="min-w-full table-auto text-white border-collapse text-sm">
        <thead class="bg-red-800 text-white uppercase tracking-wider text-xs">
          <tr>
            <th class="w-24 px-2 py-1 text-left">Date</th>
            <th class="w-24 px-2 py-1 text-left">Type</th>
            <th class="px-2 py-1 text-left">Th√®mes</th>
            <th class="px-2 py-1 text-left">Notes</th>
          </tr>
        </thead><tbody>`;

      data.forEach(e => {
        const d = new Date(e.date).toLocaleDateString();
        html += `<tr class="border-t border-white/10 hover:bg-white/10">
          <td class="px-2 py-1">${d}</td>
          <td class="px-2 py-1">${e.type_entretien}</td>
          <td class="px-2 py-1">${(e.themes_abordes || []).join(', ')}</td>
          <td class="px-2 py-1 whitespace-pre-wrap break-words max-w-full">${e.notes}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      container.innerHTML = html;
    });
}

function changeHistoriquePage(step) {
  if (!currentHistId) return;
  currentHistPage += step;
  if (currentHistPage < 1) currentHistPage = 1;
  if (currentHistPage > totalHistPages) currentHistPage = totalHistPages;
  loadHistorique(currentHistId);
}
</script>



<script>
function exportHistoriqueCSV() {
  if (!currentHistId) return;

  fetch(`/entretiens?resident_id=${currentHistId}`)
    .then(res => res.json())
    .then(data => {
      const rows = data.map(e => [
        new Date(e.date).toLocaleDateString(),
        e.type_entretien,
        (e.themes_abordes || []).join(', '),
        e.notes?.replace(/\r?\n|\r/g, " ") || ""
      ]);
      const csv = ["Date,Type,Th√®mes,Notes", ...rows.map(r => r.map(v => `"${v}"`).join(","))].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `historique_resident_${currentHistId}.csv`;
      link.click();
    });
}
</script>


<script>
let isDrawing = false;
let canvas = null;
let ctx = null;
  
// Initialisation des √©v√©nements pour le canvas de signature
window.addEventListener("DOMContentLoaded", () => {
  canvas = document.getElementById("signaturePad");
  if (!canvas) return;

  ctx = canvas.getContext("2d");
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#111827";

  canvas.addEventListener("mousedown", commencerDessin);
  canvas.addEventListener("mousemove", dessiner);
  canvas.addEventListener("mouseup", terminerDessin);
  canvas.addEventListener("mouseout", terminerDessin);

  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    commencerDessin({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
  });

  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    dessiner({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
  });

  canvas.addEventListener("touchend", terminerDessin);

  // Boutons
  const effacerBtn = document.getElementById("effacer-signature");
  if (effacerBtn) effacerBtn.addEventListener("click", effacerSignature);

  const validerBtn = document.getElementById("valider-signature");
  if (validerBtn) validerBtn.addEventListener("click", async () => {
    const dataUrl = canvas.toDataURL();
    if (dataUrl.length < 2000) return alert("Merci de signer avant de valider.");

    const id_resident = document.getElementById("numero").value;
    if (!id_resident) return alert("R√©sident non s√©lectionn√©");

    try {
      const url = await uploadSignatureToFirebase(dataUrl, id_resident);
      if (!url) return;
      document.getElementById("signatureModal").classList.add("hidden");
      envoyerFormulaire(url);
    } catch (err) {
      console.error("Erreur Firebase :", err);
      alert("‚ùå Erreur lors de l'envoi de la signature.");
    }
  });
});

function commencerDessin(e) {
  isDrawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
}

function dessiner(e) {
  if (!isDrawing) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
}

function terminerDessin() {
  isDrawing = false;
}

function effacerSignature() {
  if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
}

async function uploadSignatureToFirebase(dataUrl, id_resident) {
  try {
    const fileName = `signatures/${id_resident}_${Date.now()}.png`;
    const storageRef = firebase.storage().ref().child(fileName);
    await storageRef.putString(dataUrl, 'data_url');
    const downloadURL = await storageRef.getDownloadURL();
    console.log("‚úÖ Signature enregistr√©e :", downloadURL);
    return downloadURL;
  } catch (err) {
    console.error("‚ùå Firebase upload error :", err);
    return null;
  }
}
</script>

<!-- Signature modal -->
<div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
  <div class="bg-white p-4 rounded shadow-md w-full max-w-md text-black">
    <h2 class="text-xl font-bold mb-2">‚úçÔ∏è Signez ci-dessous</h2>
    <canvas id="signaturePad" class="border w-full h-40"></canvas>
    <div class="flex justify-between mt-4">
      <button id="effacer-signature" class="px-4 py-1 bg-gray-300 rounded">Effacer</button>
      <button id="valider-signature" class="px-4 py-1 bg-green-600 text-white rounded">Valider</button>
    </div>
  </div>
</div>

<script src="logique-formulaire.js"></script>
</body>
</html>
  
  
