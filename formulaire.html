<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test Signature vers Supabase</title>
  <style>
    canvas { border: 1px solid #ccc; margin-top: 10px; }
    button { margin-right: 10px; }
  </style>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>✍️ Dessine ta signature puis envoie-la</h2>

  <canvas id="signaturePad" width="400" height="150"></canvas><br>
  <button onclick="effacer()">Effacer</button>
  <button onclick="envoyer()">Envoyer la signature</button>

  <script>
    // 🔧 Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyDf8hbsFHQ5MAEssfM6SeF2s1Glc0JTS7U",
      authDomain: "suivimediateuras.firebaseapp.com",
      projectId: "suivimediateuras",
      storageBucket: "suivimediateuras.appspot.com",
      messagingSenderId: "385344535314",
      appId: "1:385344535314:web:019fb10e56e4a408a491cb"
    });

    firebase.auth().signInAnonymously().then(() => {
      console.log("✅ Firebase connecté");
    });

    // ✅ Supabase
    const supabase = window.supabase.createClient(
      "https://bmanspqauleydsxdvtpy.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtYW5zcHFhdWxleWRzeGR2dHB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwNjgwNzEsImV4cCI6MjA1ODY0NDA3MX0.-m80mGof0FL3pFU0m1_UOGcNVpo9xm1WD037ZtFAy-w"
    );

    const canvas = document.getElementById("signaturePad");
    const ctx = canvas.getContext("2d");
    let isDrawing = false;

    // ✍️ Dessin
    canvas.addEventListener("mousedown", (e) => {
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });
    canvas.addEventListener("mousemove", (e) => {
      if (!isDrawing) return;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    });
    canvas.addEventListener("mouseup", () => isDrawing = false);
    canvas.addEventListener("mouseout", () => isDrawing = false);

    function effacer() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // 🚀 Envoi Firebase + Supabase
    async function envoyer() {
      const dataUrl = canvas.toDataURL();
      if (dataUrl.length < 2000) return alert("✋ Signature vide");

      const id_resident = "5cf9e6df-e495-4c1a-bd36-69065c48ba08"; // 🔁 Résident Arnaud SÉRON
      const fileName = `signatures/${id_resident}_${Date.now()}.png`;

      try {
        const ref = firebase.storage().ref().child(fileName);
        await ref.putString(dataUrl, 'data_url');
        const url = await ref.getDownloadURL();
        console.log("✅ Signature URL :", url);

        const { error } = await supabase
          .from("entretiens")
          .insert([{
            id_resident,
            type_entretien: "test",
            themes_abordes: ["test_signature"],
            notes: "Test manuel d'envoi",
            signature_url: url
          }]);

        if (error) {
          console.error("❌ Supabase :", error.message);
          alert("Erreur Supabase : " + error.message);
        } else {
          alert("✅ Signature envoyée !");
          effacer();
        }
      } catch (e) {
        console.error("❌ Firebase ou Supabase :", e);
        alert("Erreur lors de l'envoi");
      }
    }
  </script>
</body>
</html>  

  
  
